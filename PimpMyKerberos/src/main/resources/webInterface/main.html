<html>
	<head>
	   <script src="javascript/utils.js"></script>
	   <title>PimpMyKerberos</title>
	   <link rel="stylesheet" type="text/css" href="css/semantic.css"/>
	   <link rel="stylesheet" type="text/css" href="css/main.css"/>
	   <link rel="stylesheet" type="text/css" href="css/calendar.min.css"/>
		<link rel="stylesheet" type="text/css" href="css/jquery-ui.min.css"/>
 	   

	
		<script>

		var timeLineJson="";
		var displayMenu=0;
		const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour :'numeric', minute:'numeric',second: 'numeric' };
		
		function display(id){
				//console.log("Can display now " + id);
			    document.getElementById(id).style.display="block";
			    document.getElementById("wait_" + id).style.display="none";
			}
		
		
		$(document).ready(function() {
		
			WebSocketClient.open(url("hello")); 
			reloadMemory();reloadSpace();loadLiveCamera();
			loadStoreCamera(true);
		
			setInterval(reloadMemory, 10000);
			setInterval(reloadSpace, 10000);
			
			$("#calendar").datepicker(
				{
					onSelect: function(dateText) {
								     			    console.log("Selected date: " + dateText + "; input's current value: " + this.value);
													getValueFromUrl("camera?action=fromDay&date="+ dateText,true,function (json){
																try {
																	timeLineJson=JSON.parse(json);
																	console.log("from picker " + timeLineJson);
																	loadStoreCamera(true);	
																	}
																	catch (e)
																	{
																		console.log(e);
																	}
													});
											    } 
				}
			);
			$("#calendar").datepicker("option","dateFormat","yy-mm-dd");
				
			
			
			
			
			
			$("body").delegate(".browsable", "click", function(){
							
							name=$(this).attr("name");
							$("#pathHeader").html(name);
							getValueFromUrl("camera?action=getDir&sub=" + name,true,function (json)
							{
								directoryJson=JSON.parse(json);
								try {
									html="";
									for (i=0;i<directoryJson.length;i++)
									{
										directory=directoryJson[i];
										html+="<div style=width:500px class=\"item\"><i name=\"" + directory.name + "\" class=\"browsable folder icon\"></i><div class=\"content\"><div class=\"header\">" + directory.name + "</div></div></div>";										
									}
									$("#items").html(html);
								} catch (e)
								{
									top.location.href="/";
								}
								
							});
								    
		    });
		
			$("#logout").click(function(e){
				getValueFromUrl("admin?action=logout",true,function (){
					top.location.href="/";
					
				});
			});
			
			
			$("#cleanAll").click(function(e){
				button=$(this);
				button.addClass("loading");
				getValueFromUrl("camera?action=cleanAll",true,function (){
					button.removeClass("loading");	
					timeLineJson="";
					reloadSpace();
					loadStoreCamera(true);	
				});
			});
			
			$("body").delegate(".cleanable", "click", function(){
				button=$(this);
				button.addClass("loading");
				id=$(this).attr("id");
				getValueFromUrl("camera?action=cleanCam&id="+ id,true,function (){
					button.removeClass("loading");
					timeLineJson="";
					reloadSpace();
					loadStoreCamera(true);	
				});
			});
			
			$("body").delegate(".seekable", "click", function(){
				button=$(this);
				button.addClass("loading");
				id=$(this).attr("id");
				getValueFromUrl("camera?action=seek&id="+ id,true,function (json){
					try {
						timeLineJson=JSON.parse(json);
						console.log(timeLineJson);
						loadStoreCamera(true);	
						}
						catch (e)
						{
							console.log(e);
						}
					
					button.removeClass("loading");	
				});
			});
							
		
			
			$(window).scroll(function(){

				//console.log("Reload top:" + $(".loadMore").last().offset().top + " scrollTop:" +  $(window).scrollTop() );
				if ( ($(".loadMore").last().offset().top - 1000)  < $(window).scrollTop())
				{
					$("body").find(".forceDisplay").show();
					$("body").find(".waitingPimp").hide();
					
					
					$(".loadMore").last().remove();
					console.log("Complete Reload");
					loadStoreCamera(false);
				}
				
    		});
			
			
			
				$("#menuDisplay").click(function(e)
					{
						if ( displayMenu == 0 )
						{
							$("#menu").show();
							$("#menu").transition('fly left');
							displayMenu=1;
						}else
						{
								$("#menu").hide();
								$("#menu").transition('slide up')
								displayMenu=0;
						}
					});	
		
		
			$("#setPath").click(function(e){
				
				
				
				
				$("#path").modal({
					onApprove : function() {
											// Check if docker-compose find
											getValueFromUrl("camera?action=isDockerCompose&dir=" + $("#pathHeader").html(),true,function (presence){
												if ( presence == "true")
												{
													setPath();
												}else
												{
													$("#noDockerCompose").modal({
																	onApprove : function() {
																		setPath();
																	}
																	}).modal('show');;
												}
												
												});	
										    },
					onDeny     : function () {
						$("#items").html('<div class="item"><i name="/" class="browsable folder icon"></i><div class="content"><div class="header">/</div></div></div>');
					}
				}).modal('show');
			});
	
			
		function loadStoreCamera(redraw)
		{
			var crunch="";
			if ( timeLineJson != "" )
			{

				if ( redraw )
				 {
					crunch="&startCrunch=" + (timeLineJson.startCrunch);
				 }else
				 {
					crunch="&startCrunch=" + (timeLineJson.endCrunch);				
				 }
	
			}
			
			getValueFromUrl("camera?action=getTimeLine" + crunch,true,function(json){
													
				try {
					timeLineJson=JSON.parse(json);
					console.log(timeLineJson);
					html="<table>";
					for ( i=0;i<timeLineJson.maxLineDisplay;i++)
					{
						html+="<tr>";
						timeLine=timeLineJson.cameraToMedia[i];
						for ( k=0;k<timeLineJson.maxColumnDisplay;k++)
						{
							if ( typeof timeLine[k] == "undefined"){
								html+="<td><div style=height:250px;background-color:white;width:100%; /></td>";
							}else
							{
								html+="<td >";
								 html += "<div id=\"wait_" + k + "_" + timeLine[k].time + "\" style=border-radius:5px;height:250px><i style=z-index:200 class=\"waitingPimp notched circle loading icon\"></i></div>";
								 if ( timeLine[k].pathToMedia.endsWith("mp4"))
									{
										 aDate=new Date(timeLine[k].time);
									
										 html += "<div><center>" + aDate.toLocaleDateString(undefined, options) +  "</center></div>";
										 html += "<video id=\"" + k + "_" + timeLine[k].time + "\" oncanplay=\"display('" + k +"_" + timeLine[k].time + "');\" class=\"videoCam forceDisplay\" loop=\"true\" muted autoplay=\"true\" preload=\"auto\" style=display:none;border-radius:5px; height=250 controls src=\"/display?fileName=" + timeLine[k].pathToMedia + "\">not loading</video>";										
									}else
									{
										 html += "<img class=forceDisplay height=250 id=\"" + k + "_" + timeLine[k].time + "\" src=" + timeLine[k].pathToMedia + "\"/>";										
									}
								html+="</td>";
								//console.log(timeLine[k]);
							}
						}						
					html+="</tr>";
					}
					if ( redraw) 
					{
											$("#camContent").html(html + "</table><div class=\"ui segment loadMore\" style=width:100%;height:100px></div>");
					}else
					{
											$("#camContent").append(html + "</table><div class=\"ui segment loadMore\" style=width:100%;height:100px></div>");						
					}

					
				} catch (e)
				{
					console.log(e);
				}
														
			});
			
			
			
		}
		
		function loadLiveCamera()
		{
			getValueFromUrl("camera?action=getCameras",true,function(json){
													
				try {
					cameraJson=JSON.parse(json);
					html="<table><tr>";
					for ( i=0;i<cameraJson.length;i++)
					{
						camera=cameraJson[i];
						if ( camera.ip != "" )
						{
							ip=camera.ip;
						}else
						{
							ip=window.location.hostname;
						}
 						html+="<td>";
							html+="<button id=\"" + camera.name + "\" class=\"seekable tiny red ui labeled icon button\"><i class=\"angle double down icon\"></i>Seek</button>";
							html+="<button id=\"" + camera.name + "\" class=\"cleanable tiny orange ui labeled icon button\"><i class=\"trash icon\"></i>Purge Files</button>";
							html+="<button class=\"tiny blue ui labeled icon button\"><i class=\"wrench icon\"></i><a target=new href=http://" + ip +":" + camera.kerberosPort + ">Settings</a></button>";
							html+="<br><a target=new href=http://" + ip +":" + camera.broadcastPort + " ><img style=border-radius:5px;z-index:1000 height=250px src=http://" + ip +":" + camera.broadcastPort+"/></a>"
						html+="</td>";
					}
					$("#cameraHeader").html(html + "</tr></table>");
					
				} catch (e)
				{
					console.log(e);
				}
														
			});
		}
		
		function setPath()
		{
			
			$("#ConfirmIcon").addClass("loading");
			getValueFromUrl("camera?action=setPath&path=" + $("#pathHeader").html(),true,function(){
																$("#ConfirmIcon").removeClass("loading");
																loadLiveCamera();
																createMenu();
																loadStoreCamera();
			});
		}
			
			function reloadMemory()
			{
				
				getValueFromUrl("admin?action=getMemory",true,function (memory){
					try{
						memories=JSON.parse(memory);
						percent=parseFloat(memories.used) * 100 / parseFloat(memories.max);
						//console.log(percent + " " +memories.used + " " + memories.max);
						used=parseFloat(memories.used) * 1024;
						total=parseFloat(memories.max) * 1024;
						//console.log(used + " " +total);
						$('#memory')
						  .progress({
							percent: percent,
							value: used,
							total: total,
						    text: {
						      active  : 'Using {value} of {total} memory megabytes',
						    }
						  })
						;
						
					}catch (e)
					{
						console.log(e);
					}
					
				});
				
			}
			
			function reloadSpace()
			{
				
				getValueFromUrl("admin?action=getSpace",true,function (space){
					try{
						spaces=JSON.parse(space);
						percent=parseFloat(spaces.used) * 100 / parseFloat(spaces.max);
						//console.log(percent + " " +memories.used + " " + memories.max);
						used=parseFloat(spaces.used);
						total=parseFloat(spaces.max);
						//console.log(used + " " +total);
						$('#space')
						  .progress({
							percent: percent,
							value: used,
							total: total,
						    text: {
						      active  : 'Using {value} of {total} space megabytes ({percent}%)',
						    }
						  })
						;
						
					}catch (e)
					{
						console.log(e);
					}
					
				});
				
			}
			
			

		});					
		</script>

   	</head>
	<body id=body>
	
		<div class=memory style=position:fixed;top:0px;width:100%;z-index:1000>
		    <div id=memory style=width:100% class="ui tiny indicating progress">
	  			<div class="bar"></div>
	  			<div style="color:black;" class="label">Memory</div>
			</div>
		</div>
		
		<div class=memory style=position:fixed;bottom:1px;height:40px;width:100%;z-index:1000;background-color:white>
		    <div id=space style=width:100% class="ui tiny indicating progress">
	  			<div class="bar"></div>
	  			<div style="color:black;" class="label">Space</div>
			</div>
		</div>
	
		<button id=menuDisplay style=position:fixed;z-index:2000;right:-4px;top:0px class="big ui icon button">
  			<i class="bars icon"></i>
		</button>
		
		
		
		<div id=menu style=display:none;position:fixed;z-index:2000;right:-4px;top:42px class="ui compact vertical labeled icon menu">
			  <a class="item">
			    <i id=setPath class="home icon"></i>
			    Set kerberos.io path
			  </a>
			  <a class="item">
			    <i onclick=javascript:window.open('https://github.com/coxifred/PimpMyKerberos') class="github icon"></i>
			   PimpMyKerberos
			  </a>
			  <a class="item">
				<i id=cleanAll class="trash icon"></i>
			   	Clean old files
			  </a>
			  <a class="item">
				<i onclick=javascript:window.open('admin?action=save') id=save class="save icon"></i>
			   	Save config
			  </a>
	 		  <a class="item">
				<i onclick=javascript:window.open('admin?action=getLogs') id=logs class="archive icon"></i>
			   	Logs
			  </a>
			  <a class="item">
			    <i id=logout class="power off icon"></i>
			    Logout
			  </a>
			</div>
		
		
	
		
		<div style=position:fixed;z-index:1000;top:5px;right:50px class="ui calendar" >
			    <div class="ui input left icon">
			      <i class="calendar icon"></i>
			      	<input type="text" placeholder="Date" id="calendar">
			    </div>
			</div>
			

 			

<div id=cameraHeader style=position:fixed;z-index:1000;top:40px;margin-left:20px;margin-right:20px;width:100%>

</div>


<div id=fond style=position:fixed;z-index:500;top:0px;height:350px;width:100%;background-color:white;>

</div>
	


<div id=camContent style=position:relative;top:350px;margin-left:20px;margin-right:20px;width:100%;left:-3px;height:100%;background-color:white; >
  
</div>
	
	
	
	
<div id=path class="ui modal">
  <i class="close icon"></i>
  <div id=pathHeader class="header">
    Point to kerberos.io directory containing docker-compose.yml
  </div>
  <div class="image content">
    <div class="description">
				  <div id=items class="ui list">
				  	<div class="item">
				    	<i name="/" class="browsable folder icon"></i>
				    	<div class="content">
				      		<div class="header">/</div>
				    	</div>
				  	</div>  
				  </div>
    </div>
  </div>
  <div class="actions">
	<div class="ui black deny button">
      Return at the top
    </div>
    <div id=Confirm class="ui positive right labeled icon button">
      Confirm
      <i id=ConfirmIcon class="checkmark icon"></i>
    </div>
  </div>
</div>
	
<div id=noDockerCompose class="tiny ui modal">
  <div class="header">No docker-compose.yml file found</div>
  <div class="content">
    <p>Continue ?</p>
  </div>
  <div class="actions">
    <div class="ui approve button">Yes</div>
    <div class="ui cancel button">Cancel</div>
  </div>
</div>


<div id=disconnect class="ui basic modal">
  <div class="ui icon header">
    <i class="plug icon"></i>
    Lost Connection/Disconnected, please click when ok
  </div>
  <div class="content">
   		<center><img style=position:relative;top:200px height=40% src=images/wolf.png><center>
		<div style=position:relative;bottom:-300px;right:2px; class="footer">A product by <img style=position:relative;top:32px height=64px src=images/bab.png><a href=https://github.com/coxifred>Coxifred</a></div>
  </div>
  <div class="actions">
    <div class="ui green ok inverted button">
      <i class="checkmark icon"></i>
      Ack
    </div>
  </div>
</div>
	
<div style=position:fixed;display:none;bottom:50px;right:10px;z-index:3000;width:300px;background-color:#DFDFDF;border-radius:5px; id=reloadMessage class="card">
    <div class="content">
      <img id=messageImage class="right floated mini ui image" src="">
      <div class="header">
        New Detection
      </div>
      <div class="meta">
        Something is moving
      </div>
      <div class="description">
        <div id=messageDetail></div>
      </div>
    </div>
    <div class="extra content">
      <div class="ui three buttons">
        <div class="ui basic green button">Reload</div>
        <div class="ui basic orange button">Mute</div>
        <div class="ui basic red button">Decline</div>
      </div>
    </div>
  </div>

	
</body>
</html>
